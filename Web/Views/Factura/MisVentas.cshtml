@model Infraestructure.Models.Factura

@{
    ViewBag.Title = "Mis Ventas";
}

<div class="container-fluid m-auto text-center pt-5">
    <h1 class="page-title">Mis Ventas</h1>
</div>


<script>

    function getDateString(date) {
        var dateObj = new Date(parseInt(date.substr(6)));
        return dateObj.toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' });
    }

    $(document).ready(function () {
        $('#productoGrid').dataTable({
            "processing": true,
            "serverSide": true,
            "filter": false,
            "bFilter": false,
            "orderMulti": false,
            "pageLength": 5,
            "scrollX": true,
            "language": {
                "lengthMenu": "Muestre _MENU_ productos por página",
                "zeroRecords": "No logramos encontrar los productos - Perdón :(",
                "info": "Mostrando página _PAGE_ de _PAGES_",
                "infoEmpty": "No hay productos para mostrar",
                "infoFiltered": "(filtrado de _MAX_ productos totales)",
                    "paginate": {
                    "first": "Primera",
                    "last": "Última",
                    "next": "Siguiente",
                    "previous": "Previa"
                },
                "search": "Buscar  "
            },

            "ajax": {
                "url": "/Factura/LoadVentas",
                "type": "POST",
                "datatype": "json"
            },
            "columnDefs":
                [
                    {
                    "targets": [0],
                    "visible": false,
                    "searchable": false
                    },
                    {
                        "targets": [5],
                        "visible": true,
                        "searchable": false,
                        "orderable": false,
                    },
                ],

            "columns": [
                { "data": "Id", "name": "Id", "autoWidth": true },
                {
                    "data": "Fecha", "name": "Fecha",
                    "render": function (data) { return getDateString(data); }
                },
                { "data": "Producto", "name": "Producto", "autoWidth": true },
                { "data": "Cantidad", "name": "Cantidad", "autoWidth": true },
                { "data": "Estado", "name": "Estado", "autoWidth": true },
                {
                    "render": function (data, type, full, meta) {
                        if (full.IdEstado == 5) { 
                        return '<a title="Marcar como enviado" class="btn Detalle"  onclick="ActualizarDetalle(' + full.IdOrden + ',' + full.IdProducto + ', 6)"> <i class="fa-solid fa-truck-fast fa-xl" style="color: #8045d9;"></i> </a>';
                        }
                        if (full.IdEstado == 6) { 
                            return '<a title="Marcar como entregado" class="btn Editar" onclick="ActualizarDetalle(' + full.IdOrden + ',' + full.IdProducto + ', 9)"><i class="fa-solid fa-circle-check fa-xl" style="color: #c23c81;"></i></a>';
                        }
                        if (full.IdEstado == 9 && full.IdEvaluacionProv == null) {
                            return '<a title="Evaluar cliente" class="btn Editar"   onclick="CrearEvaluacion(' + full.IdComprador + ',' + full.IdOrden + ',' + full.IdProducto + ')" ><i class="fa-solid fa-star fa-xl" style="color: #cf7b06;"></i></a>';
                        } else {
                            return '<a class="btn Editar"><i class="fa-regular fa-circle-check" style="color: #121212;"></i></a>';
                        }
                },
                }
            ]

        });
    });


    function ActualizarDetalle(_orden, _producto, _estado) {

        var texto;
        if (_estado == 6) {
            texto = "¿Estas seguro que deseas marcar este producto como enviado?"
        } else {
            texto = "¿Estas seguro que deseas marcar este producto como entregado?"

        }
        Swal.fire({
            title: '¡Un segundo!',
            text: texto,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#a847ea',
            cancelButtonColor: '#d33',
            confirmButtonText: "Cambiar estado",
            cancelButtonText: "Cancelar"

        }).then((resulto) => {
            if (resulto.isConfirmed) {
                $.ajax({
                    method: "GET",
                    url: "/Factura/ActualizarOrden",
                    data: {
                        "orden": _orden, "producto": _producto, "estado": _estado
                    },
                    success: function (result) {
                        Swal.fire(
                            '¡Completado!',
                            'Has cambiado el estado de esta orden con exito',
                            'success'
                        )
                        $('#productoGrid').DataTable().destroy();
                        $('#productoGrid').dataTable({
                            "processing": true,
                            "serverSide": true,
                            "filter": false,
                            "bFilter": false,
                            "orderMulti": false,
                            "pageLength": 5,
                            "scrollX": true,
                            "language": {
                                "lengthMenu": "Muestre _MENU_ productos por página",
                                "zeroRecords": "No logramos encontrar los productos - Perdón :(",
                                "info": "Mostrando página _PAGE_ de _PAGES_",
                                "infoEmpty": "No hay productos para mostrar",
                                "infoFiltered": "(filtrado de _MAX_ productos totales)",
                                "paginate": {
                                    "first": "Primera",
                                    "last": "Última",
                                    "next": "Siguiente",
                                    "previous": "Previa"
                                },
                                "search": "Buscar  "
                            },

                            "ajax": {
                                "url": "/Factura/LoadVentas",
                                "type": "POST",
                                "datatype": "json"
                            },
                            "columnDefs":
                                [
                                    {
                                        "targets": [0],
                                        "visible": false,
                                        "searchable": false
                                    },
                                    {
                                        "targets": [5],
                                        "visible": true,
                                        "searchable": false,
                                        "orderable": false,
                                    },
                                ],

                            "columns": [
                                { "data": "Id", "name": "Id", "autoWidth": true },
                                {
                                    "data": "Fecha", "name": "Fecha",
                                    "render": function (data) { return getDateString(data); }
                                },
                                { "data": "Producto", "name": "Producto", "autoWidth": true },
                                { "data": "Cantidad", "name": "Cantidad", "autoWidth": true },
                                { "data": "Estado", "name": "Estado", "autoWidth": true },
                                {
                                    "render": function (data, type, full, meta) {
                                        if (full.IdEstado == 5) {
                                            return '<a title="Marcar como enviado" class="btn Detalle"  onclick="ActualizarDetalle(' + full.IdOrden + ',' + full.IdProducto + ', 6)"> <i class="fa-solid fa-truck-fast fa-xl" style="color: #8045d9;"></i> </a>';
                                        }
                                        if (full.IdEstado == 6) {
                                            return '<a title="Marcar como entregado" class="btn Editar" onclick="ActualizarDetalle(' + full.IdOrden + ',' + full.IdProducto + ', 9)"><i class="fa-solid fa-circle-check fa-xl" style="color: #c23c81;"></i></a>';
                                        }
                                        if (full.IdEstado == 9 && full.IdEvaluacionProv == null) {
                                            return '<a title="Evaluar cliente" class="btn Editar"   onclick="CrearEvaluacion(' + full.IdComprador + ',' + full.IdOrden + ',' + full.IdProducto + ')" ><i class="fa-solid fa-star fa-xl" style="color: #cf7b06;"></i></a>';
                                        } else {
                                            return '<a class="btn Editar"><i class="fa-regular fa-circle-check" style="color: #121212;"></i></a>';
                                        }
                                    }
                                }
                            ]

                        });



                    },
                    error: function (xhr, status, error) {
                        console.log("Error: " + error, "No Error: " + xhr.status)
                    }
                });

            }
        })
    }

        function CrearEvaluacion(idCliente, idOrden, idProducto) {
            $.ajax({
                method: "POST",
                url: "/Factura/EvaluarCliente",
                data: { "id": idCliente, "idOrden":idOrden, "idProducto": idProducto },
                success: function (result) {
                    $(".modal-body").html("");
                    $(".modal-body").html(result);
                    $("#myModal").modal("show");
                }, error: function (xhr, status, error) {
                    console.log("Error: " + error, "No Error: " + xhr.status)
                }
            });
        }


</script>

<div class=" ">
    <br />
    <div style=" width:101%; margin:0 auto;">
        <table id="productoGrid" class="table table-striped table-bordered dt-responsive nowrap overflow-x-scroll" width="100%" cellspacing="0">
            <thead>
                <tr>
                    <th>Id</th> @* 0 *@
                    <th>Fecha</th> @* 0 *@
                    <th>Producto</th> @* 1 *@
                    <th>Cantidad</th> @* 2 *@
                    <th>Estado</th> @* 4 *@
                    <th></th> @* 5 *@
                </tr>
            </thead>
        </table>
    </div>

    @* Modal *@
    <input type="hidden" id="campoOculto" />
    <div class="modal" tabindex="-1" id="myModal">
        <div class="modal-dialog modal-lg box-eval" role="document">
            <div class="modal-content">
                <div class="modal-header" style="border: none">
                    <h5 class="head-Title">Evaluar Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="background-color: #2222226c; border-radius: 10px; margin: 3px 10px; border: 1px solid #ffffff23">
                    <p>Modal body text goes here.</p>
                </div>
                <div class="modal-footer" style="border:none;">
                    <button type="button" class="btn btn-detalle" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
    @* Modal *@

</div>